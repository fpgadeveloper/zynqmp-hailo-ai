// Copyright (C) 2021 Xilinx, Inc
// SPDX-License-Identifier: BSD-3-Clause

/include/ "system-conf.dtsi"
#include <dt-bindings/phy/phy.h>

/ {
	model = "TUL PYNQ-ZU RevB";

	reserved-memory {
		#address-cells = <2>;
		#size-cells = <2>;
		ranges;

		linux,cma {
			linux,cma-default;
			compatible = "shared-dma-pool";
			alloc-ranges = <0x0 0x0 0x0 0x7ff00000>;
			size = <0x0 0x20000000>;
			alignment = <0x0 0x2000>;
			reusable;
		};
	};

	wmmcsdio_fixed:fixedregulator-mmcsdio {
		compatible = "regulator-fixed";
		regulator-name = "wmmcsdio_fixed";
		regulator-min-microvolt = <3300000>;
		regulator-max-microvolt = <3300000>;
		regulator-always-on;
		regulator-boot-on;
	};

	sdio_pwrseq: sdio_pwrseq {
		compatible = "mmc-pwrseq-simple";
		// MIO[5] RESETN for WILC3000 active low
		reset-gpios = <&gpio 5 1>;
		// requires a patched pwrseq_simple.c for WILC3000
		chip_en-gpios = <&gpio 4 1>;
		post-power-on-delay-ms = <10>;
	};

	leds {
		compatible = "gpio-leds";

		ps_led0 {
			label = "ps_led0";
			gpios = <&gpio 0x11 0x0>;
			linux,default-trigger = "heartbeat";
		};

		ps_led1 {
			label = "ps_led1";
			gpios = <&gpio 0x14 0x0>;
			default-state = "on";
		};

		vbus_det {
			label = "vbus_det";
			gpios = <&gpio 0x7 0x0>;
			default-state = "on";
		};

	};

	gpio-keys {
		compatible = "gpio-keys";
		autorepeat;

		ps_sw0 {
			label = "ps_sw0";
			gpios = <&gpio 0x17 0x0>;
			linux,code = <0x74>;
			gpio-key,wakeup;
		};
	};

	dp_clk: psgtr_dp_clock {
		compatible = "fixed-clock";
		#clock-cells = <0x00>;
		clock-frequency = <27000000>;
	};

	usb_clk: psgtr_usb_clock {
		compatible = "fixed-clock";
		#clock-cells = <0x00>;
		clock-frequency = <26000000>;
	};

	dp_aclk: dp_aclk {
		compatible = "fixed-clock";
		#clock-cells = <0>;
		clock-frequency = <100000000>;
		clock-accuracy = <100>;
	};
	
	/* Repairing misc_clks as per Article number 000036480 */
	/delete-node/ misc_clk_0;
	misc_clk_0: misc_clk_0 {
		#clock-cells = <0>;
		clock-frequency = <99999000>;
		compatible = "fixed-clock";
	};

	/delete-node/ misc_clk_1;
	misc_clk_1: misc_clk_1 {
		#clock-cells = <0>;
		clock-frequency = <249997500>;
		compatible = "fixed-clock";
	};

	/delete-node/ misc_clk_2;
	misc_clk_2: misc_clk_2 {
		#clock-cells = <0>;
		clock-frequency = <199998000>;
		compatible = "fixed-clock";
	};

	ref_si5324: ref_si5324 {
	    compatible = "fixed-clock";
	    #clock-cells = <0>;
	    clock-frequency = <100000000>;
	};
};

&i2c0 {
	status = "okay";
	clock-frequency = <400000>;

	i2c-mux@75 {
		compatible = "nxp,pca9548";
		#address-cells = <1>;
		#size-cells = <0>;
		reg = <0x75>;

		i2c@0 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x0>;

			irps5401_43: irps5401@43 {
				#clock-cells = <0x0>;
				compatible = "infineon,irps5401";
				reg = <0x43>;
			};

			irps5401_44: irps5401@44 {
				#clock-cells = <0x0>;
				compatible = "infineon,irps5401";
				reg = <0x44>;
			};

			irps5401_46: irps5401@46 {
				#clock-cells = <0x0>;
				compatible = "infineon,irps5401";
				reg = <0x46>;
			};
		};

		i2c@1 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x1>;
			si5340: clock-generator@74 {
				compatible = "silabs,si5340";
				reg = <0x74>;
			};
		};

		i2c@2 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x2>;
			label = "AUDIO";
		};

		i2c@3 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x3>;
			label = "RPICAM";
		};

		i2c@4 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x4>;
			label = "SYZYGY";
		};

		i2c@5 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x5>;
			label = "FMC";
		};

		i2c@6 {
			#address-cells = <0x1>;
			#size-cells = <0x0>;
			reg = <0x6>;
			label = "USB";
		};
	};
};

&psgtr {
	/* usb3, dp */
	#clock-cells = <0x01>;
	clocks = <&usb_clk>, <&dp_clk>;
	clock-names = "ref0", "ref1";
};

&usb0 {
	/* USB Gadget*/
	status = "okay";
	phys = <&psgtr 2 PHY_TYPE_USB3 0 0>;
	phy-names = "usb3-phy";
};

&dwc3_0 {
	status = "okay";
	dr_mode = "peripheral";
	label = "USB Gadget";
	maximum-speed = "super-speed";
	snps,usb2-lpm-disable;
	snps,usb3_lpm_capable;
	snps,dis_u2_susphy_quirk;
	snps,dis_u3_susphy_quirk;
};

&usb1 {
	// USB Hub
	status = "okay";
	phys = <&psgtr 3 PHY_TYPE_USB3 1 0>;
	phy-names = "usb3-phy";
};

&dwc3_1 {
	status = "okay";
	dr_mode = "host";
	label = "USB Hub";
	maximum-speed = "super-speed";
	snps,usb2-lpm-disable;
	snps,usb3_lpm_capable;
	snps,dis_u2_susphy_quirk;
	snps,dis_u3_susphy_quirk;
};

&sdhci0 {
	status = "okay";
	disable-wp;
	no-1-8-v;
};

&sdhci1 {
	status = "okay";
	max-frequency = <50000000>;
	broken-mmc-highspeed;
	disable-wp;
	non-removable;
	bus-width = <0x4>;
	mmc-pwrseq = <&sdio_pwrseq>;
	vqmmc-supply = <&wmmcsdio_fixed>;
	#address-cells = <0x1>;
	#size-cells = <0x0>;
	wilc_sdio@1 {
			compatible = "microchip,wilc3000";
			status = "okay";
			bus-width = <0x4>;
			reg = <0x0>;
			irq-gpios = <&gpio 45 0>;
		};
};

&zynqmp_dpsub {
    status = "okay";
    clocks = <&dp_aclk>,<&zynqmp_clk DP_AUDIO_REF>,<&zynqmp_clk DP_VIDEO_REF>,<&display_pipeline_clk_wiz_0 0>;
    clock-names = "dp_apb_clk", "dp_aud_clk","dp_vtc_pixel_clk_in","dp_live_video_in_clk";
    xlnx,bridge = <&display_pipeline_v_tc_0>;

    dp_port: port@0 {
        reg = <0>;
        dp_encoder: endpoint {
            remote-endpoint = <&mixer_crtcdisplay_pipeline_v_mix_0>;
        };
    };
};

&amba_pl {
	imx219_clk: imx219_clk {
		#clock-cells = <0x0>;
		clock-frequency = <24000000>;
		compatible = "fixed-clock";
	};

	imx219_vana: fixedregulator@3 {
		compatible = "regulator-fixed";
		regulator-name = "imx219_vana";
		regulator-min-microvolt = <2800000>;
		regulator-max-microvolt = <2800000>;
		enable-active-high;
	};

	imx219_vdig: fixedregulator@4 {
		compatible = "regulator-fixed";
		regulator-name = "imx219_vdig";
		regulator-min-microvolt = <1800000>;
		regulator-max-microvolt = <1800000>;
	};

	imx219_vddl: fixedregulator@5 {
		compatible = "regulator-fixed";
		regulator-name = "imx219_vddl";
		regulator-min-microvolt = <1200000>;
		regulator-max-microvolt = <1200000>;
	};
};

/*
&hdmi_axi_iic {
	si5324: clock-generator@68 {
		status = "okay";
		compatible = "silabs,si5324";
		reg = <0x68>;
		#address-cells = <1>;
        #size-cells = <0>;
        #clock-cells = <1>;
        clocks = <&ref_si5324>;
        clock-names = "clkin2";
        
        fmc_si5324_clk: clk0@0 {
            reg = <0>;
            clock-frequency = <100000000>;
        };
	};
};
*/

&mipi_1_axi_iic_0 {
	imx219_cam1: sensor@10 {
		compatible = "sony,imx219";
		reg = <0x10>;
		clocks = <&imx219_clk>;
		VANA-supply = <&imx219_vana>;   /* 2.8v */
		VDIG-supply = <&imx219_vdig>;   /* 1.8v */
		VDDL-supply = <&imx219_vddl>;   /* 1.2v */

		port {
		     imx219_cam1_0: endpoint {
			remote-endpoint = <&mipi_csi_inmipi_1_mipi_csi2_rx_subsyst_0>;
			data-lanes = <1 2>;
			link-frequencies = /bits/ 64 <456000000>;
			};
		};
	};
};

&mipi_2_axi_iic_0 {
	imx219_cam2: sensor@10 {
		compatible = "sony,imx219";
		reg = <0x10>;
		clocks = <&imx219_clk>;
		VANA-supply = <&imx219_vana>;   /* 2.8v */
		VDIG-supply = <&imx219_vdig>;   /* 1.8v */
		VDDL-supply = <&imx219_vddl>;   /* 1.2v */

		port {
		     imx219_cam2_0: endpoint {
			remote-endpoint = <&mipi_csi_inmipi_2_mipi_csi2_rx_subsyst_0>;
			data-lanes = <1 2>;
			link-frequencies = /bits/ 64 <456000000>;
			};
		};
	};
};

&mipi_1_mipi_csi2_rx_subsyst_0 {
	xlnx,en-active-lanes;
};

&mipi_2_mipi_csi2_rx_subsyst_0 {
	xlnx,en-active-lanes;
};

&mipi_csi_inmipi_1_mipi_csi2_rx_subsyst_0 {
	remote-endpoint = <&imx219_cam1_0>;
};

&mipi_csi_inmipi_2_mipi_csi2_rx_subsyst_0 {
	remote-endpoint = <&imx219_cam2_0>;
};

&mipi_1_isppipeline {
	reset-gpios = <&gpio 94 1>;
	xlnx,max-height = /bits/ 16 <1232>;
	xlnx,max-width = /bits/ 16 <1920>;
	xlnx,rgain = /bits/ 16 <128>;
	xlnx,bgain = /bits/ 16 <210>;
	xlnx,pawb = /bits/ 16 <350>;
	xlnx,mode-reg = <1>;
};

&isppipeline_port0mipi_1_isppipeline {
	xlnx,video-width = <10>;
	xlnx,cfa-pattern = "rggb";
};

&isppipeline_port1mipi_1_isppipeline {
	xlnx,video-width = <8>;
	xlnx,cfa-pattern = "rggb";
};

&mipi_2_isppipeline {
	reset-gpios = <&gpio 102 1>;
	xlnx,max-height = /bits/ 16 <1232>;
	xlnx,max-width = /bits/ 16 <1920>;
	xlnx,rgain = /bits/ 16 <128>;
	xlnx,bgain = /bits/ 16 <210>;
	xlnx,pawb = /bits/ 16 <350>;
	xlnx,mode-reg = <1>;
};

&isppipeline_port0mipi_2_isppipeline {
	xlnx,video-width = <10>;
	xlnx,cfa-pattern = "rggb";
};

&isppipeline_port1mipi_2_isppipeline {
	xlnx,video-width = <8>;
	xlnx,cfa-pattern = "rggb";
};

&mipi_1_v_proc {
	compatible = "xlnx,v-vpss-scaler-2.2";
};

&mipi_2_v_proc {
	compatible = "xlnx,v-vpss-scaler-2.2";
};

&display_pipeline_clk_wiz_0 {
	#address-cells = <2>;
};

&mixer_crtcdisplay_pipeline_v_mix_0 {
	remote-endpoint = <&dp_encoder>;
};

&display_pipeline_v_mix_0 {
	xlnx,disp-bridge = <&zynqmp_dpsub>;
};

&display_pipeline_v_tc_0 {
	compatible = "xlnx,bridge-v-tc-6.1";
	xlnx,pixels-per-clock = <1>;
};

&mipi_csi_port1mipi_1_mipi_csi2_rx_subsyst_0 {
	xlnx,cfa-pattern = "rggb";
	xlnx,video-format = <12>;
	xlnx,video-width = <8>;
};

&mipi_csi_port0mipi_1_mipi_csi2_rx_subsyst_0 {
	xlnx,cfa-pattern = "rggb";
	xlnx,video-format = <12>;
	xlnx,video-width = <8>;
};

&mipi_csi_port1mipi_2_mipi_csi2_rx_subsyst_0 {
	xlnx,cfa-pattern = "rggb";
	xlnx,video-format = <12>;
	xlnx,video-width = <8>;
};

&mipi_csi_port0mipi_2_mipi_csi2_rx_subsyst_0 {
	xlnx,cfa-pattern = "rggb";
	xlnx,video-format = <12>;
	xlnx,video-width = <8>;
};

